<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YOLO Real-Time Detection</title>
  <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.7/dist/css/styles.min.css" rel="stylesheet"/>
  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
  <style>
    .video-wrap{position:relative;display:inline-block}
    .hud{position:absolute;right:.5rem;top:.5rem;background:rgba(33,37,41,.7);color:#fff;padding:.35rem .5rem;border-radius:.5rem;font-size:.9rem}
    .hud small{opacity:.8}
    .status-dot{width:.6rem;height:.6rem;border-radius:50%;display:inline-block;margin-right:.35rem;background:#adb5bd}
    .status-dot.on{background:#51cf66}
    .status-dot.err{background:#fa5252}
    .status-dot.warn{background:#fab005}
    .skeleton{width:100%;min-height:240px;background:repeating-linear-gradient( -45deg, #f1f3f5, #f1f3f5 10px, #e9ecef 10px, #e9ecef 20px)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body class="sb-nav-fixed">
  <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="{{ url_for('index') }}">YOLO Detector</a>
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle"><i class="fas fa-bars"></i></button>
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4"></ul>
  </nav>

  <div id="layoutSidenav">
    <div id="layoutSidenav_nav">
      <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
        <div class="sb-sidenav-menu">
          <div class="nav">
            <div class="sb-sidenav-menu-heading">Navigation</div>
            <a class="nav-link active" href="{{ url_for('webcam_page') }}">
              <div class="sb-nav-link-icon"><i class="fas fa-video"></i></div>
              Live Detection
            </a>
            <a class="nav-link" href="{{ url_for('about') }}">
              <div class="sb-nav-link-icon"><i class="fas fa-info-circle"></i></div>
              About
            </a>
          </div>
        </div>
      </nav>
    </div>

    <div id="layoutSidenav_content">
      <main>
        <div class="container-fluid px-4">
          <h1 class="mt-4">Real-Time Detection</h1>
          <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item active">Live Detection</li>
          </ol>

          <div class="row">
            <div class="col-md-5">
              <div class="card bg-light mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <span><i class="fas fa-tachometer-alt me-1"></i> Stream Stats</span>
                  <div class="d-flex align-items-center gap-2">
                    <span class="small text-muted me-2">Model</span>
                    <select id="model-select" class="form-select form-select-sm mono" style="min-width:220px"></select>
                  </div>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Status</span>
                    <span><span id="status-dot" class="status-dot"></span><strong id="stat-status">INIT</strong></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Resolution</span><strong id="stat-res">-</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>FPS</span><strong id="stat-fps">-</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Frame Index</span><strong id="stat-frame">-</strong>
                  </div>
                  <hr/>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Person</span>
                    <span><span id="person-dot" class="status-dot"></span><strong id="person-status">UNKNOWN</strong></span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>PPE Status</span>
                    <span><span id="ppe-dot" class="status-dot"></span><strong id="ppe-status">UNKNOWN</strong></span>
                  </div>
                  <div class="mt-3 small text-muted" id="model-hint"></div>
                </div>
                <div class="card-footer small text-muted">
                  Updates every 0.5s
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header">
              <i class="fas fa-video me-1"></i> Webcam Feed
            </div>
            <div class="card-body text-center">
              <div class="video-wrap">
                <img id="video" src="{{ url_for('video_feed') }}" alt="Webcam feed"
                     class="img-fluid" style="max-height:65vh;border:1px solid #dee2e6;border-radius:.25rem;"/>
                <div class="hud" id="hud" hidden>
                  <div><small>RES</small> <span id="hud-res">-</span></div>
                  <div><small>FPS</small> <span id="hud-fps">-</span></div>
                </div>
              </div>
              <div id="skeleton" class="skeleton mt-3 d-none"></div>
              <div class="mt-3">
                <a class="btn btn-outline-secondary btn-sm" href="/snapshot.jpg" target="_blank">
                  <i class="fa-solid fa-camera me-1"></i> Snapshot
                </a>
              </div>
            </div>
          </div>
        </div>
      </main>
      <footer class="py-4 bg-light mt-auto">
        <div class="container-fluid px-4">
          <div class="d-flex align-items-center justify-content-between small">
            <div class="text-muted"></div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.7/dist/js/scripts.min.js"></script>
  <script>
    let lastOkTs = 0;
    const LS_KEY_MODEL = "yd_selected_model";
    function basename(p){ return p ? p.split(/[\\/]/).pop() : p; }

    function setSelectToPath(sel, targetPath){
      if(!targetPath) return false;
      sel.value = targetPath;
      if(sel.value === targetPath) return true;
      const tb = basename(targetPath);
      for(const opt of sel.options){
        if(basename(opt.value) === tb){ sel.value = opt.value; return true; }
      }
      return false;
    }

    async function loadModels(){
      const r = await fetch("/api/models", {cache:"no-store"});
      const d = await r.json();
      const sel = document.getElementById("model-select");
      sel.innerHTML = "";
      (d.files || []).forEach(fp => {
        const opt = document.createElement("option");
        opt.value = fp;
        opt.textContent = basename(fp);
        sel.appendChild(opt);
      });
      const pref = localStorage.getItem(LS_KEY_MODEL);
      if(!setSelectToPath(sel, pref) && !setSelectToPath(sel, d.requested) && !setSelectToPath(sel, d.loaded)){
        if(sel.options.length) sel.selectedIndex = 0;
      }
      updateModelHint(d);
    }

    function updateModelHint(d){
      const hint = document.getElementById("model-hint");
      const rq = d.requested ? basename(d.requested) : "-";
      const ld = d.loaded ? basename(d.loaded) : "-";
      const err = d.error ? ` (last error: ${d.error})` : "";
      const same = (d.requested && d.loaded && d.requested === d.loaded);
      hint.textContent = same
        ? `Loaded model: ${ld}`
        : `Switching... requested: ${rq}, loading: ${ld}${err}`;
    }

    async function changeModel(path){
      localStorage.setItem(LS_KEY_MODEL, path);
      await fetch("/api/select_model", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ path })
      });
      refreshModels();
    }

    async function refreshModels(){
      try{
        const r = await fetch("/api/models", {cache:"no-store"});
        const d = await r.json();
        updateModelHint(d);
        const sel = document.getElementById("model-select");
        setSelectToPath(sel, d.requested || d.loaded);
      }catch{}
    }

    async function pollStats() {
      try {
        const [sRes, ppeRes] = await Promise.all([
          fetch("/api/stream_stats", { cache: "no-store" }),
          fetch("/api/ppe_status", { cache: "no-store" }),
        ]);
        const s = await sRes.json();
        const p = await ppeRes.json();

        const ok = (s && (s.width ?? 0) > 0);
        document.getElementById("stat-res").textContent   = s.resolution ?? "-";
        document.getElementById("stat-fps").textContent   = (s.fps ?? 0).toString();
        document.getElementById("stat-frame").textContent = (s.frame_index ?? 0).toString();
        document.getElementById("hud-res").textContent = s.resolution ?? "-";
        document.getElementById("hud-fps").textContent = (s.fps ?? 0).toFixed(1);
        document.getElementById("hud").hidden = !ok;

        const dot = document.getElementById("status-dot");
        const st  = document.getElementById("stat-status");
        if (ok) { lastOkTs = Date.now(); dot.className = "status-dot on"; st.textContent = "RUNNING"; }
        else if (Date.now() - lastOkTs > 4000) { dot.className = "status-dot err"; st.textContent = "NO SIGNAL"; }
        else { dot.className = "status-dot"; st.textContent = "INIT"; }

        const pdot = document.getElementById("person-dot");
        const pst  = document.getElementById("person-status");
        if (p.has_person) { pdot.className = "status-dot on"; pst.textContent = "DETECTED"; }
        else { pdot.className = "status-dot"; pst.textContent = "NONE"; }

        const ppedot = document.getElementById("ppe-dot");
        const ppest  = document.getElementById("ppe-status");
        if (!p.has_person)      { ppedot.className = "status-dot";     ppest.textContent = "NO PERSON"; }
        else if (p.status_code === "safe") { ppedot.className = "status-dot on";  ppest.textContent = "SAFE"; }
        else if (p.status_code === "violation") { ppedot.className = "status-dot err"; ppest.textContent = p.status_text; }
        else { ppedot.className = "status-dot warn"; ppest.textContent = p.status_text || "CHECK"; }
      } catch (e) {}
    }

    document.addEventListener("change", (ev)=>{
      if(ev.target && ev.target.id === "model-select"){
        changeModel(ev.target.value);
      }
    });

    loadModels().then(()=>refreshModels());
    setInterval(refreshModels, 1000);
    pollStats();
    setInterval(pollStats, 500);

    const img = document.getElementById('video');
    const skeleton = document.getElementById('skeleton');
    img.addEventListener('load', () => { skeleton.classList.add('d-none'); });
    img.addEventListener('error', () => { skeleton.classList.remove('d-none'); });
  </script>
</body>
</html>